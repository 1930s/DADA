# Log分析進階

## Log分析三大階段

*   收集
*   轉換（ETL）
*   儲存
*   分析

嗯...發現有些問題，Log回答不出來？

可能你缺了些資料來源，或者是沒有設定好讓他把該吐出來的訊息吐出來

## Device Tuning

#### 收集

Syslog

#### 收集＋解析

fluentd

#### 儲存

FluxDB

#### 分析

Grafana

## 正式Log分析

### 前期準備

*   瞭解環境
*   了解產品保護的目標
*   了解產品
*   取得原廠的Log規格說明

### 遇到未知的Log

假設

驗證

### 分析

*   這個log是代表什麼意義？
*   實際上這條log是因為發生了什麼事而產生？（人、事、時、地、物）
*   這個log裡面有哪些角色、哪些環境資訊、大概可以分幾類？
*   在場景中，什麼是正常？什麼是異常？

### 實例

取得iptables防火牆log

### 現成工具

Apache log工具

## Log儲存

特性：循序寫入

適合的媒介：SATA

不可篡改：Append only

Logrotate

壓縮

串流讀取

驗證：CRC, MD5

### 權限配置

如前面提到的，駭客對於log的興趣與可以獲得的利益遠比系統管理者還大，所以避免log被隨意讀取是非常重要的事情

-rw-r-----  640是常見的配置 

可公開的log才會出現644

進階安全性：append only

*   chattr +a test.log

或SELinux

但，根據對方打得深入程度，本機的安全性遲早會被破的，所以Log的異地備援與即時分析成為了重點

## Log傳輸

### 常見傳輸方法

*   UDP Syslog
*   File

特性：串流

Time is metter

是否加密？

是否壓縮？

是否驗證每筆記錄？

如果傳遞失誤？

奇技淫巧：吸血鬼牙

## 攻擊與對抗

### 駭客的目標

*   抹除蹤跡
*   誤導方向
*   探索內部、搜尋攻擊目標
*   直接攻擊高權限的管理者

### 攻擊手法與對抗手法

*   篡改內容

        *   換行字元
    *   假造欄位資訊
    *   超長數據覆蓋
    *   格式破壞

*   刪除檔案
*   Span

## 進階 - Log解析

### 為什麼要解析？

正規化

### 常見格式

*   固定字元分隔
*   固定長度分隔
*   key-value
*   JSON
*   XML
*   自然語言
*   混合

### 關於邊界處理

假設我們有一個CSV的檔案格式中，訊息欄位剛好有一個逗號存在...?

*   MSQ
*   escape delimiter char

### 欄位的常見格式

*    數字

         *   整數
     *   浮點數
     *   科學記號
     *   0xF

*    字串
*    時間

     *   timestamp

             *   epoch
     *   unix timestamp

     *   mysql time format
*    跨時區分析

*    ID

     *   數字遞增
*    UID / GUID   18A90565AF7E-552E04EF-007B-5C78-DF19

### 解析方法

*   Regex

### 解析工具

### 效能

### 範例